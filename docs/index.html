<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>IT 자산 관리 대시보드</title>

<style>
  :root {
    --bg:#0f1116;
    --card:#161a22;
    --text:#e5e7eb;
    --muted:#9ca3af;
    --line:#2a2f3a;
  }

  body {
    margin:0;
    font-family: system-ui, -apple-system, Segoe UI, Roboto;
    background:var(--bg);
    color:var(--text);
  }

  .wrap {
    max-width:1100px;
    margin:28px auto;
    padding:0 16px;
  }

  h1 { margin:0 0 14px; }

  .kpi {
    display:flex;
    gap:12px;
    margin:0 0 14px;
    flex-wrap:wrap;
  }

  .kpi .card {
    background:var(--card);
    border:1px solid var(--line);
    border-radius:12px;
    padding:12px 16px;
    min-width:110px;
    cursor:pointer;
    user-select:none;
    transition: transform .08s ease, border-color .15s ease, box-shadow .15s ease;
  }
  .kpi .card:hover{
    transform: translateY(-1px);
    border-color:#3a4354;
    box-shadow: 0 10px 28px rgba(0,0,0,.25);
  }
  .kpi .card.active {
    border-color:#4b5563;
    box-shadow:0 0 0 1px #4b5563;
  }

  .kpi .n {
    font-size:20px;
    font-weight:700;
    margin-top:6px;
  }

  .summary{
    margin: 0 0 14px;
    background: var(--card);
    border:1px solid var(--line);
    border-radius:12px;
    padding:12px 14px;
  }
  .summary h2{
    margin:0 0 10px;
    font-size:14px;
    color:#cfd5e1;
  }
  .summary table{
    width:100%;
    border-collapse:collapse;
  }
  .summary th, .summary td{
    padding:9px 10px;
    border-bottom:1px solid var(--line);
    font-size:13px;
  }
  .summary th{
    background:#121620;
    font-weight:600;
  }
  .num { text-align:right; }
  .summary .hint{
    color:var(--muted);
    font-size:13px;
    padding:10px 2px 2px;
  }

  .toolbar {
    display:flex;
    gap:12px;
    flex-wrap:wrap;
    margin:0 0 14px;
  }

  input, select {
    background:#0b0e14;
    color:var(--text);
    border:1px solid var(--line);
    border-radius:10px;
    padding:10px 12px;
  }

  table {
    width:100%;
    border-collapse:collapse;
    background:var(--card);
    border:1px solid var(--line);
    border-radius:12px;
    overflow:hidden;
  }

  th, td {
    padding:12px;
    border-bottom:1px solid var(--line);
    vertical-align: middle;
  }

  th {
    background:#121620;
    font-weight:600;
  }

  tr:hover { background:#0f1420; }

  .badge {
    display:inline-block;
    padding:4px 10px;
    border-radius:999px;
    font-size:12px;
    font-weight:700;
    color:#fff;
    line-height: 1.1;
  }
  .st-in { background:#16a34a; }
  .st-out { background:#f97316; }
  .st-repair { background:#6b7280; }
  .st-retired { background:#dc2626; }
  .st-unknown { background:#374151; }

  .btn {
    padding:6px 10px;
    border-radius:10px;
    border:1px solid var(--line);
    background:#0b0e14;
    color:var(--text);
    cursor:pointer;
    font-size:12px;
    font-weight:600;
  }
  .btn:hover { background:#141a2a; }

  .empty {
    color:var(--muted);
    text-align:center;
    padding:32px;
  }
</style>
</head>

<body>
<div class="wrap">
  <h1>IT 자산 관리 대시보드</h1>

  <div class="kpi">
    <div class="card" id="card-total">총 자산<div class="n" id="k-total">0</div></div>
    <div class="card" id="card-in">IN<div class="n" id="k-in">0</div></div>
    <div class="card" id="card-out">OUT<div class="n" id="k-out">0</div></div>
    <div class="card" id="card-repair">수리중<div class="n" id="k-repair">0</div></div>
    <div class="card" id="card-retired">폐기<div class="n" id="k-retired">0</div></div>
  </div>

  <div class="summary" id="summary"></div>

  <div class="toolbar">
    <input id="q" placeholder="검색" />
    <select id="status">
      <option value="">상태 전체</option>
      <option value="in">IN</option>
      <option value="out">OUT</option>
      <option value="repair">수리중</option>
      <option value="retired">폐기</option>
    </select>
  </div>

  <table>
    <thead>
      <tr>
        <th style="width:70px">#</th>
        <th style="width:120px">구분</th>
        <th>모델명</th>
        <th style="width:170px">시리얼</th>
        <th style="width:150px">사용자</th>
        <th style="width:140px">구매일</th>
        <th style="width:130px">상태</th>
        <th style="width:110px">인쇄</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>

  <div class="empty" id="empty" style="display:none;">표시할 자산이 없습니다.</div>
</div>

<script>
async function main(){
  const res = await fetch('assets.json', {cache:'no-store'});
  const issues = await res.json();

  function pick(body, r){
    const m = body.match(r);
    return m ? m[1].trim() : '-';
  }

  // ✅ 라벨 문자열/객체 모두 처리
  function normalizeLabels(rawLabels){
    return (rawLabels || []).map(l => {
      if (typeof l === 'string') return l.toLowerCase();
      if (l && typeof l === 'object' && l.name) return String(l.name).toLowerCase();
      return '';
    }).filter(Boolean);
  }

  function labelsToKey(labels){
    if (labels.includes('in')) return 'in';
    if (labels.includes('out')) return 'out';
    if (labels.includes('repair')) return 'repair';
    if (labels.includes('retired')) return 'retired';
    return 'unknown';
  }

  function keyToText(key){
    if (key === 'in') return 'IN';
    if (key === 'out') return 'OUT';
    if (key === 'repair') return '수리중';
    if (key === 'retired') return '폐기';
    return '미지정';
  }

  function keyToBadgeClass(key){
    if (key === 'in') return 'st-in';
    if (key === 'out') return 'st-out';
    if (key === 'repair') return 'st-repair';
    if (key === 'retired') return 'st-retired';
    return 'st-unknown';
  }

  const assets = issues.map(i=>{
    const body = i.body || '';
    const labels = normalizeLabels(i.labels);
    const stateKey = labelsToKey(labels);

    return {
      number: i.number,
      type: pick(body, /구분:\s*(.+)/),
      model: i.title || '-',
      serial: pick(body, /시리얼:\s*(.+)/),
      user: pick(body, /사용자:\s*(.+)/),
      buy: pick(body, /구매일:\s*([0-9\-\.]+)/).replace(/\./g,'-'),
      stateKey,
      stateText: keyToText(stateKey),
      hay: (body + ' ' + (i.title||'') + ' ' + labels.join(' ')).toLowerCase()
    };
  });

  // KPI
  setText('k-total', assets.length);
  setText('k-in', assets.filter(a=>a.stateKey==='in').length);
  setText('k-out', assets.filter(a=>a.stateKey==='out').length);
  setText('k-repair', assets.filter(a=>a.stateKey==='repair').length);
  setText('k-retired', assets.filter(a=>a.stateKey==='retired').length);

  const tbody = el('tbody');
  const empty = el('empty');
  const summary = el('summary');

  function renderSummary(modeKey){
    let title = '전체 자산 현황';
    let list = assets;

    if (modeKey !== 'total'){
      const nameMap = { in:'IN', out:'OUT', repair:'수리중', retired:'폐기' };
      title = (nameMap[modeKey] || modeKey) + ' 자산 현황';
      list = assets.filter(a => a.stateKey === modeKey);
    }

    const map = {};
    for (const a of list){
      const t = a.type || '-';
      map[t] = (map[t] || 0) + 1;
    }

    const types = Object.keys(map).sort();
    if (!types.length){
      summary.innerHTML = `
        <h2>${escapeHtml(title)}</h2>
        <div class="hint">해당 상태에 해당하는 자산이 없습니다.</div>
      `;
      return;
    }

    const rows = types.map(t => `
      <tr>
        <td>${escapeHtml(t)}</td>
        <td class="num">${map[t]}</td>
      </tr>
    `).join('');

    summary.innerHTML = `
      <h2>${escapeHtml(title)}</h2>
      <table>
        <thead>
          <tr>
            <th>구분</th>
            <th class="num">수량</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
    `;
  }

  function renderTable(){
    const q = el('q').value.trim().toLowerCase();
    const st = el('status').value;

    const rows = assets.filter(a => {
      const qHit = !q || a.hay.includes(q);
      const stHit = !st || a.stateKey === st;
      return qHit && stHit;
    });

    tbody.innerHTML = rows.map(a => `
      <tr>
        <td>${a.number}</td>
        <td>${escapeHtml(a.type)}</td>
        <td>${escapeHtml(a.model)}</td>
        <td>${escapeHtml(a.serial)}</td>
        <td>${escapeHtml(a.user)}</td>
        <td>${escapeHtml(a.buy)}</td>
        <td><span class="badge ${keyToBadgeClass(a.stateKey)}">${escapeHtml(a.stateText)}</span></td>
        <td><button class="btn" onclick="printAsset('${escapeAttr(a.model)}','${escapeAttr(a.serial)}','${escapeAttr(a.user)}','${escapeAttr(a.buy)}')">인쇄</button></td>
      </tr>
    `).join('');

    empty.style.display = rows.length ? 'none' : 'block';
  }

  function setActive(modeKey){
    ['total','in','out','repair','retired'].forEach(k => el('card-'+k).classList.remove('active'));
    el('card-'+modeKey).classList.add('active');
  }

  el('card-total').addEventListener('click', ()=>{ setActive('total'); renderSummary('total'); });
  el('card-in').addEventListener('click', ()=>{ setActive('in'); renderSummary('in'); });
  el('card-out').addEventListener('click', ()=>{ setActive('out'); renderSummary('out'); });
  el('card-repair').addEventListener('click', ()=>{ setActive('repair'); renderSummary('repair'); });
  el('card-retired').addEventListener('click', ()=>{ setActive('retired'); renderSummary('retired'); });

  el('q').addEventListener('input', renderTable);
  el('status').addEventListener('change', renderTable);

  setActive('total');
  renderSummary('total');
  renderTable();
}

function el(id){ return document.getElementById(id); }
function setText(id, v){ el(id).textContent = v; }

function printAsset(model, serial, user, buy){
  const w = window.open('', '_blank', 'width=520,height=420');
  if (!w) return;

  w.document.write(`
    <html>
    <head>
      <title>자산 인쇄</title>
      <style>
        body{font-family:sans-serif;padding:24px;}
        h2{margin:0 0 14px;}
        p{margin:6px 0;}
        .card{border:1px solid #ddd;border-radius:10px;padding:16px;}
        button{margin-top:12px;padding:8px 12px;border-radius:8px;border:1px solid #bbb;background:#fff;cursor:pointer;}
      </style>
    </head>
    <body>
      <div class="card">
        <h2>IT 자산 정보</h2>
        <p><strong>모델명:</strong> ${escapeHtml(model)}</p>
        <p><strong>시리얼:</strong> ${escapeHtml(serial)}</p>
        <p><strong>사용자:</strong> ${escapeHtml(user)}</p>
        <p><strong>구매일:</strong> ${escapeHtml(buy)}</p>
        <button onclick="window.print()">인쇄</button>
      </div>
    </body>
    </html>
  `);
  w.document.close();
}

function escapeHtml(s){
  return String(s ?? '')
    .replaceAll('&','&amp;')
    .replaceAll('<','&lt;')
    .replaceAll('>','&gt;')
    .replaceAll('"','&quot;')
    .replaceAll("'","&#39;");
}
function escapeAttr(s){
  return String(s ?? '')
    .replaceAll('\\','\\\\')
    .replaceAll("'","\\'")
    .replaceAll('"','&quot;')
    .replaceAll('<','&lt;')
    .replaceAll('>','&gt;');
}

main().catch(e => console.error(e));
</script>
</body>
</html>
