<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>IT ìì‚° ê´€ë¦¬ ëŒ€ì‹œë³´ë“œ</title>

<style>
  :root {
    --bg:#0f1116;
    --card:#161a22;
    --text:#e5e7eb;
    --muted:#9ca3af;
    --line:#2a2f3a;

    --c-total:#60a5fa;
    --c-in:#22c55e;
    --c-out:#fb923c;
    --c-repair:#9ca3af;
    --c-retired:#ef4444;
  }

  body {
    margin:0;
    font-family: system-ui, -apple-system, Segoe UI, Roboto;
    background:var(--bg);
    color:var(--text);
  }

  .wrap {
    max-width:1100px;
    margin:26px auto;
    padding:0 16px;
  }

  h1 { margin:0 0 14px; letter-spacing:-.2px; }

  /* KPI */
  .kpi {
    display:flex;
    gap:12px;
    margin:0 0 14px;
    flex-wrap:wrap;
  }

  .kpi .card {
    background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,0));
    border:1px solid var(--line);
    border-radius:14px;
    padding:12px 16px;
    min-width:128px;
    cursor:pointer;
    user-select:none;
    transition: transform .08s ease, border-color .15s ease, box-shadow .15s ease;
  }

  .kpi .card:hover{
    transform: translateY(-1px);
    border-color:#3a4354;
    box-shadow: 0 10px 26px rgba(0,0,0,.28);
  }

  .kpi .label {
    display:flex;
    align-items:center;
    gap:8px;
    font-weight:650;
    color:#d7dde9;
  }

  .dot{
    width:10px; height:10px;
    border-radius:999px;
    background: var(--line);
    box-shadow: 0 0 0 2px rgba(255,255,255,.03) inset;
  }

  .kpi .n {
    font-size:22px;
    font-weight:800;
    margin-top:8px;
    letter-spacing:-.3px;
  }

  .card[data-kind="total"] .dot{ background: var(--c-total); }
  .card[data-kind="in"] .dot{ background: var(--c-in); }
  .card[data-kind="out"] .dot{ background: var(--c-out); }
  .card[data-kind="repair"] .dot{ background: var(--c-repair); }
  .card[data-kind="retired"] .dot{ background: var(--c-retired); }

  .kpi .card.active{
    border-color: rgba(255,255,255,.18);
    box-shadow: 0 0 0 1px rgba(255,255,255,.12), 0 14px 34px rgba(0,0,0,.32);
  }
  .kpi .card.active[data-kind="total"]{ box-shadow: 0 0 0 1px rgba(96,165,250,.55), 0 14px 34px rgba(0,0,0,.32); }
  .kpi .card.active[data-kind="in"]{ box-shadow: 0 0 0 1px rgba(34,197,94,.55), 0 14px 34px rgba(0,0,0,.32); }
  .kpi .card.active[data-kind="out"]{ box-shadow: 0 0 0 1px rgba(251,146,60,.55), 0 14px 34px rgba(0,0,0,.32); }
  .kpi .card.active[data-kind="repair"]{ box-shadow: 0 0 0 1px rgba(156,163,175,.55), 0 14px 34px rgba(0,0,0,.32); }
  .kpi .card.active[data-kind="retired"]{ box-shadow: 0 0 0 1px rgba(239,68,68,.55), 0 14px 34px rgba(0,0,0,.32); }

  /* ìš”ì•½ */
  .summary{
    margin: 0 0 14px;
    background: var(--card);
    border:1px solid var(--line);
    border-radius:14px;
    padding:12px 14px;
  }

  .summary-head{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
    margin: 0 0 10px;
  }

  .summary h2{
    margin:0;
    font-size:14px;
    color:#cfd5e1;
  }

  .pill{
    display:inline-flex;
    align-items:center;
    gap:8px;
    padding:6px 10px;
    border-radius:999px;
    border:1px solid rgba(255,255,255,.12);
    background: rgba(255,255,255,.03);
    color:#dbe2ef;
    font-size:12px;
    font-weight:650;
    cursor:default;
  }

  .linkbtn{
    padding:6px 10px;
    border-radius:10px;
    border:1px solid var(--line);
    background:#0b0e14;
    color:var(--text);
    cursor:pointer;
    font-size:12px;
    font-weight:650;
  }
  .linkbtn:hover{ background:#141a2a; }

  /* âœ… ìš”ì•½ í‘œë¥¼ ê°€ìš´ë°ë¡œ ëª¨ìœ¼ê¸° */
  .summary-inner{
    max-width: 760px;      /* í•µì‹¬: í­ ì œí•œ */
    margin: 0 auto;        /* ê°€ìš´ë° ì •ë ¬ */
  }

  .summary table{
    width:100%;
    border-collapse:collapse;
    table-layout: fixed;
  }
  .summary th, .summary td{
    padding:10px 10px;
    border-bottom:1px solid var(--line);
    font-size:13px;
  }
  .summary th{
    background:#121620;
    font-weight:650;
  }

  .summary th.type { width: 72%; }
  .summary th.qty { width: 28%; text-align:right; }
  .summary td.qty { text-align:right; }

  .typecell{
    display:flex;
    align-items:center;
    gap:10px;
    min-width:0;
  }
  .typeicon{
    width:28px;
    height:28px;
    border-radius:10px;
    border:1px solid rgba(255,255,255,.10);
    background: rgba(255,255,255,.03);
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:15px;
    flex: 0 0 auto;
  }
  .typename{
    overflow:hidden;
    text-overflow:ellipsis;
    white-space:nowrap;
    font-weight:650;
    color:#e6ebf5;
  }

  /* âœ… ìš”ì•½ í–‰ í´ë¦­ ê°€ëŠ¥í•˜ê²Œ */
  .summary tbody tr {
    cursor:pointer;
    transition: background .12s ease;
  }
  .summary tbody tr:hover{
    background: rgba(96,165,250,.06);
  }

  .summary .hint{
    color:var(--muted);
    font-size:13px;
    padding:10px 2px 2px;
    text-align:center;
  }

  /* í•„í„° */
  .toolbar {
    display:flex;
    gap:12px;
    flex-wrap:wrap;
    margin:0 0 14px;
  }

  input, select {
    background:#0b0e14;
    color:var(--text);
    border:1px solid var(--line);
    border-radius:12px;
    padding:10px 12px;
  }

  /* í…Œì´ë¸” */
  table.main {
    width:100%;
    border-collapse:collapse;
    background:var(--card);
    border:1px solid var(--line);
    border-radius:14px;
    overflow:hidden;
  }

  table.main th, table.main td {
    padding:12px;
    border-bottom:1px solid var(--line);
    vertical-align: middle;
  }

  table.main th {
    background:#121620;
    font-weight:650;
  }

  table.main tr:hover { background:#0f1420; }

  /* ìƒíƒœ ë°°ì§€ */
  .badge {
    display:inline-block;
    padding:4px 10px;
    border-radius:999px;
    font-size:12px;
    font-weight:800;
    color:#fff;
    line-height: 1.1;
  }
  .st-in { background:#16a34a; }
  .st-out { background:#f97316; }
  .st-repair { background:#6b7280; }
  .st-retired { background:#dc2626; }
  .st-unknown { background:#374151; }

  .btn {
    padding:6px 10px;
    border-radius:12px;
    border:1px solid var(--line);
    background:#0b0e14;
    color:var(--text);
    cursor:pointer;
    font-size:12px;
    font-weight:650;
  }
  .btn:hover { background:#141a2a; }

  .empty {
    color:var(--muted);
    text-align:center;
    padding:32px;
  }
</style>
</head>

<body>
<div class="wrap">
  <h1>IT ìì‚° ê´€ë¦¬ ëŒ€ì‹œë³´ë“œ</h1>

  <div class="kpi">
    <div class="card" id="card-total" data-kind="total">
      <div class="label"><span class="dot"></span>ì´ ìì‚°</div>
      <div class="n" id="k-total">0</div>
    </div>

    <div class="card" id="card-in" data-kind="in">
      <div class="label"><span class="dot"></span>IN</div>
      <div class="n" id="k-in">0</div>
    </div>

    <div class="card" id="card-out" data-kind="out">
      <div class="label"><span class="dot"></span>OUT</div>
      <div class="n" id="k-out">0</div>
    </div>

    <div class="card" id="card-repair" data-kind="repair">
      <div class="label"><span class="dot"></span>ìˆ˜ë¦¬ì¤‘</div>
      <div class="n" id="k-repair">0</div>
    </div>

    <div class="card" id="card-retired" data-kind="retired">
      <div class="label"><span class="dot"></span>íê¸°</div>
      <div class="n" id="k-retired">0</div>
    </div>
  </div>

  <div class="summary" id="summary"></div>

  <div class="toolbar">
    <input id="q" placeholder="ê²€ìƒ‰" />
    <select id="status">
      <option value="">ìƒíƒœ ì „ì²´</option>
      <option value="in">IN</option>
      <option value="out">OUT</option>
      <option value="repair">ìˆ˜ë¦¬ì¤‘</option>
      <option value="retired">íê¸°</option>
    </select>
  </div>

  <table class="main">
    <thead>
      <tr>
        <th style="width:70px">#</th>
        <th style="width:120px">êµ¬ë¶„</th>
        <th>ëª¨ë¸ëª…</th>
        <th style="width:170px">ì‹œë¦¬ì–¼</th>
        <th style="width:150px">ì‚¬ìš©ì</th>
        <th style="width:140px">êµ¬ë§¤ì¼</th>
        <th style="width:130px">ìƒíƒœ</th>
        <th style="width:110px">ì¸ì‡„</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>

  <div class="empty" id="empty" style="display:none;">í‘œì‹œí•  ìì‚°ì´ ì—†ìŠµë‹ˆë‹¤.</div>
</div>

<script>
async function main(){
  const res = await fetch('assets.json', {cache:'no-store'});
  const issues = await res.json();

  // âœ… ìš”ì•½ í´ë¦­ìš©: í˜„ì¬ ì„ íƒëœ êµ¬ë¶„ í•„í„°
  let activeTypeFilter = '';

  function pick(body, r){
    const m = body.match(r);
    return m ? m[1].trim() : '-';
  }

  function normalizeLabels(rawLabels){
    return (rawLabels || []).map(l => {
      if (typeof l === 'string') return l.toLowerCase();
      if (l && typeof l === 'object' && l.name) return String(l.name).toLowerCase();
      return '';
    }).filter(Boolean);
  }

  function labelsToKey(labels){
    if (labels.includes('in')) return 'in';
    if (labels.includes('out')) return 'out';
    if (labels.includes('repair')) return 'repair';
    if (labels.includes('retired')) return 'retired';
    return 'unknown';
  }

  function keyToText(key){
    if (key === 'in') return 'IN';
    if (key === 'out') return 'OUT';
    if (key === 'repair') return 'ìˆ˜ë¦¬ì¤‘';
    if (key === 'retired') return 'íê¸°';
    return 'ë¯¸ì§€ì •';
  }

  function keyToBadgeClass(key){
    if (key === 'in') return 'st-in';
    if (key === 'out') return 'st-out';
    if (key === 'repair') return 'st-repair';
    if (key === 'retired') return 'st-retired';
    return 'st-unknown';
  }

  function typeIcon(type){
    const t = String(type || '').toLowerCase();
    if (t.includes('ë…¸íŠ¸ë¶') || t.includes('laptop')) return 'ğŸ’»';
    if (t.includes('ëª¨ë‹ˆí„°') || t.includes('monitor')) return 'ğŸ–¥ï¸';
    if (t.includes('ë°ìŠ¤í¬íƒ‘') || t.includes('desktop') || t.includes('pc')) return 'ğŸ§ ';
    if (t.includes('í”„ë¦°í„°') || t.includes('printer')) return 'ğŸ–¨ï¸';
    return 'ğŸ“¦';
  }

  const assets = issues.map(i=>{
    const body = i.body || '';
    const labels = normalizeLabels(i.labels);
    const stateKey = labelsToKey(labels);

    return {
      number: i.number,
      type: pick(body, /êµ¬ë¶„:\s*(.+)/),
      model: i.title || '-',
      serial: pick(body, /ì‹œë¦¬ì–¼:\s*(.+)/),
      user: pick(body, /ì‚¬ìš©ì:\s*(.+)/),
      buy: pick(body, /êµ¬ë§¤ì¼:\s*([0-9\-\.]+)/).replace(/\./g,'-'),
      stateKey,
      stateText: keyToText(stateKey),
      hay: (body + ' ' + (i.title||'') + ' ' + labels.join(' ')).toLowerCase()
    };
  });

  // KPI
  setText('k-total', assets.length);
  setText('k-in', assets.filter(a=>a.stateKey==='in').length);
  setText('k-out', assets.filter(a=>a.stateKey==='out').length);
  setText('k-repair', assets.filter(a=>a.stateKey==='repair').length);
  setText('k-retired', assets.filter(a=>a.stateKey==='retired').length);

  const tbody = el('tbody');
  const empty = el('empty');
  const summary = el('summary');

  function renderSummary(modeKey){
    let title = 'ì „ì²´ ìì‚° í˜„í™©';
    let list = assets;

    if (modeKey !== 'total'){
      const nameMap = { in:'IN', out:'OUT', repair:'ìˆ˜ë¦¬ì¤‘', retired:'íê¸°' };
      title = (nameMap[modeKey] || modeKey) + ' ìì‚° í˜„í™©';
      list = assets.filter(a => a.stateKey === modeKey);
    }

    const map = {};
    for (const a of list){
      const t = a.type || '-';
      map[t] = (map[t] || 0) + 1;
    }

    const types = Object.keys(map).sort();

    const filterPill = activeTypeFilter
      ? `<span class="pill">í•„í„°: ${escapeHtml(activeTypeFilter)} <button class="linkbtn" style="margin-left:8px" id="btn-clear-type">í•„í„° í•´ì œ</button></span>`
      : '';

    if (!types.length){
      summary.innerHTML = `
        <div class="summary-head">
          <h2>${escapeHtml(title)}</h2>
          ${filterPill}
        </div>
        <div class="hint">í•´ë‹¹ ìƒíƒœì— í•´ë‹¹í•˜ëŠ” ìì‚°ì´ ì—†ìŠµë‹ˆë‹¤.</div>
      `;
      bindClearTypeIfNeeded();
      return;
    }

    const rows = types.map(t => `
      <tr data-type="${escapeAttr(t)}">
        <td>
          <div class="typecell">
            <div class="typeicon">${typeIcon(t)}</div>
            <div class="typename">${escapeHtml(t)}</div>
          </div>
        </td>
        <td class="qty">${map[t]}</td>
      </tr>
    `).join('');

    summary.innerHTML = `
      <div class="summary-head">
        <h2>${escapeHtml(title)}</h2>
        ${filterPill}
      </div>
      <div class="summary-inner">
        <table>
          <thead>
            <tr>
              <th class="type">êµ¬ë¶„</th>
              <th class="qty">ìˆ˜ëŸ‰</th>
            </tr>
          </thead>
          <tbody id="summary-body">${rows}</tbody>
        </table>
      </div>
    `;

    // âœ… ìš”ì•½ í–‰ í´ë¦­ -> ì•„ë˜ í…Œì´ë¸” êµ¬ë¶„ í•„í„°
    const sb = el('summary-body');
    if (sb){
      sb.querySelectorAll('tr[data-type]').forEach(tr=>{
        tr.addEventListener('click', ()=>{
          const t = tr.getAttribute('data-type') || '';
          activeTypeFilter = t;

          // ì‚¬ìš©ìê°€ í˜„ì¬ í•„í„°ë¥¼ ì²´ê°í•˜ê²Œ ê²€ìƒ‰ì°½ì—ë„ í‘œì‹œ
          el('q').value = t;

          renderTable();
          renderSummary(modeKey);
        });
      });
    }

    bindClearTypeIfNeeded();
  }

  function bindClearTypeIfNeeded(){
    const btn = document.getElementById('btn-clear-type');
    if (btn){
      btn.addEventListener('click', (e)=>{
        e.preventDefault();
        activeTypeFilter = '';
        el('q').value = '';
        renderTable();

        // í˜„ì¬ í™œì„± KPI ê¸°ì¤€ìœ¼ë¡œ ìš”ì•½ ì¬ë Œë”
        const mode = getActiveMode();
        renderSummary(mode);
      });
    }
  }

  function getActiveMode(){
    const modes = ['total','in','out','repair','retired'];
    for (const m of modes){
      if (el('card-'+m).classList.contains('active')) return m;
    }
    return 'total';
  }

  function renderTable(){
    const q = el('q').value.trim().toLowerCase();
    const st = el('status').value;

    const rows = assets.filter(a => {
      const qHit = !q || a.hay.includes(q);
      const stHit = !st || a.stateKey === st;
      const typeHit = !activeTypeFilter || (String(a.type || '') === String(activeTypeFilter));
      return qHit && stHit && typeHit;
    });

    tbody.innerHTML = rows.map(a => `
      <tr>
        <td>${a.number}</td>
        <td>${escapeHtml(a.type)}</td>
        <td>${escapeHtml(a.model)}</td>
        <td>${escapeHtml(a.serial)}</td>
        <td>${escapeHtml(a.user)}</td>
        <td>${escapeHtml(a.buy)}</td>
        <td><span class="badge ${keyToBadgeClass(a.stateKey)}">${escapeHtml(a.stateText)}</span></td>
        <td><button class="btn" onclick="printAsset('${escapeAttr(a.model)}','${escapeAttr(a.serial)}','${escapeAttr(a.user)}','${escapeAttr(a.buy)}')">ì¸ì‡„</button></td>
      </tr>
    `).join('');

    empty.style.display = rows.length ? 'none' : 'block';
  }

  function setActive(modeKey){
    ['total','in','out','repair','retired'].forEach(k => el('card-'+k).classList.remove('active'));
    el('card-'+modeKey).classList.add('active');
  }

  el('card-total').addEventListener('click', ()=>{ setActive('total'); renderSummary('total'); });
  el('card-in').addEventListener('click', ()=>{ setActive('in'); renderSummary('in'); });
  el('card-out').addEventListener('click', ()=>{ setActive('out'); renderSummary('out'); });
  el('card-repair').addEventListener('click', ()=>{ setActive('repair'); renderSummary('repair'); });
  el('card-retired').addEventListener('click', ()=>{ setActive('retired'); renderSummary('retired'); });

  el('q').addEventListener('input', ()=>{
    // ê²€ìƒ‰ì„ ì§ì ‘ ë°”ê¾¸ë©´ â€œêµ¬ë¶„ ê³ ì • í•„í„°â€ëŠ” ìœ ì§€í•˜ë˜, ì‚¬ìš©ìê°€ ì›ì¹˜ ì•Šìœ¼ë©´ í•´ì œ ê°€ëŠ¥
    renderTable();
  });

  el('status').addEventListener('change', renderTable);

  setActive('total');
  renderSummary('total');
  renderTable();
}

function el(id){ return document.getElementById(id); }
function setText(id, v){ el(id).textContent = v; }

function printAsset(model, serial, user, buy){
  const w = window.open('', '_blank', 'width=520,height=420');
  if (!w) return;

  w.document.write(`
    <html>
    <head>
      <title>ìì‚° ì¸ì‡„</title>
      <style>
        body{font-family:sans-serif;padding:24px;}
        h2{margin:0 0 14px;}
        p{margin:6px 0;}
        .card{border:1px solid #ddd;border-radius:10px;padding:16px;}
        button{margin-top:12px;padding:8px 12px;border-radius:8px;border:1px solid #bbb;background:#fff;cursor:pointer;}
      </style>
    </head>
    <body>
      <div class="card">
        <h2>IT ìì‚° ì •ë³´</h2>
        <p><strong>ëª¨ë¸ëª…:</strong> ${escapeHtml(model)}</p>
        <p><strong>ì‹œë¦¬ì–¼:</strong> ${escapeHtml(serial)}</p>
        <p><strong>ì‚¬ìš©ì:</strong> ${escapeHtml(user)}</p>
        <p><strong>êµ¬ë§¤ì¼:</strong> ${escapeHtml(buy)}</p>
        <button onclick="window.print()">ì¸ì‡„</button>
      </div>
    </body>
    </html>
  `);
  w.document.close();
}

function escapeHtml(s){
  return String(s ?? '')
    .replaceAll('&','&amp;')
    .replaceAll('<','&lt;')
    .replaceAll('>','&gt;')
    .replaceAll('"','&quot;')
    .replaceAll("'","&#39;");
}
function escapeAttr(s){
  return String(s ?? '')
    .replaceAll('\\','\\\\')
    .replaceAll("'","\\'")
    .replaceAll('"','&quot;')
    .replaceAll('<','&lt;')
    .replaceAll('>','&gt;');
}

main().catch(e => console.error(e));
</script>
</body>
</html>
