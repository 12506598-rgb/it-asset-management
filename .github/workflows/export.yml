name: Export Issues to JSON

# 매일 자정 + 수동 실행 지원
on:
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch:

# ✅ 리포 권한 전역 설정 (contents 쓰기 + issues 읽기)
permissions:
  contents: write
  issues: read

jobs:
  export:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Ensure docs folder exists
        run: mkdir -p docs

      # ✅ GitHub API로 이슈 전부 수집 → docs/assets.json 저장
      - name: Build assets.json with GitHub API
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            // 모든 이슈(닫힘/열림) 100개씩 페이지네이션
            const issues = await github.paginate(
              github.rest.issues.listForRepo,
              { owner, repo, state: 'all', per_page: 100 }
            );

            // 필요한 필드만 추려서 용량 줄이기
            const slim = issues.map(i => ({
              id: i.id,
              number: i.number,
              title: i.title,
              state: i.state,
              created_at: i.created_at,
              updated_at: i.updated_at,
              labels: (i.labels || []).map(l => (typeof l === 'string' ? l : l.name)),
              body: i.body || ''
            }));

            fs.writeFileSync('docs/assets.json', JSON.stringify(slim, null, 2));

      - name: Commit & Push
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add docs/assets.json
          git commit -m "Auto update assets report" || echo "No changes to commit"
          git push
